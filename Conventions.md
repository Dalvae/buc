# LLM Code Generation Conventions

This document provides guidelines for Large Language Models (LLMs) when making changes to this codebase. Adhering to these conventions will help maintain code quality, consistency, and reduce the likelihood of introducing errors.

## General Principles

- **Respect Existing Conventions**: Always use best practices and respect existing conventions, libraries, and coding styles already present in the codebase.
- **Scope Limitation**: Pay careful attention to the scope of the user's request. Do what they ask, but no more. Do not improve, comment, fix, or modify unrelated parts of the code.
- **Idempotency**: Ensure that generated code or changes are idempotent where possible, meaning applying them multiple times has the same effect as applying them once.
- **Clarity and Simplicity**: Strive for clear, simple, and maintainable code.
- **Testing**: If adding new features, consider suggesting or adding relevant tests. If modifying existing features, ensure existing tests still pass or are updated accordingly.
- **Language**: All comments and communication from the LLM must be in English.
- **Shell Commands**: LLMs must not propose or suggest running any bash scripts or shell commands. Refer to the "Human-Only Conventions" section for commands to be executed by humans.

## Backend Conventions (Python - FastAPI, SQLModel)

- **Language and Frameworks**: The backend is primarily built with Python, [FastAPI](https://fastapi.tiangolo.com/), and [SQLModel](https://sqlmodel.tiangolo.com/).
- **Type Hinting**: Python code MUST use type hints for all function signatures and variable declarations where appropriate.
- **Linters and Formatters**: Code generated by LLMs must conform to `ruff` (linting/formatting) and `mypy` (static type checking). Humans will run the necessary commands (see "Human-Only Conventions").
- **Database Migrations**: Changes to SQLModel models that affect the database schema (e.g., adding tables, columns) require modifications to the latest [Alembic](https://alembic.sqlalchemy.org/) migration file.
  - LLMs should identify the appropriate migration file (e.g., `backend/app/alembic/versions/*` or a newer one if provided by the user).
  - LLMs must propose _edits_ to the `upgrade()` and `downgrade()` functions within this latest existing migration file to reflect the schema changes.
  - LLMs must _not_ suggest creating new migration files (e.g., by suggesting `alembic revision --autogenerate`).
  - Database upgrade commands are to be run by humans (see "Human-Only Conventions").
- **API Design**: Follow RESTful principles for API design. FastAPI's features like Pydantic models for request/response validation and dependency injection should be utilized.
- **Configuration**: Backend configurations are managed via Pydantic's `BaseSettings` and environment variables defined in the `.env` file.
- **Security**: Adhere to security best practices, especially for authentication (JWT), authorization, and input validation.

## Frontend Conventions (TypeScript - React, Vite, Chakra UI)

- **Language and Frameworks**: The frontend is built with [TypeScript](https://www.typescriptlang.org/), [React](https://reactjs.org/), [Vite](https://vitejs.dev/), [Chakra UI](https://chakra-ui.com/), [TanStack Query](https://tanstack.com/query/latest), and [TanStack Router](https://tanstack.com/router/latest).
- **Component Structure**: Follow existing patterns for component structure and state management.
- **Styling**: Utilize Chakra UI components and its styling props. Custom styles should be consistent with the existing theme.
- **Linters and Formatters**: Code generated by LLMs must conform to [Biome](https://biomejs.dev/) (formatting/linting). Humans will run the necessary commands (see "Human-Only Conventions").
- **State Management**: Use TanStack Query for server state management and React's built-in state management (e.g., `useState`, `useReducer`) for UI state.
- **Routing**: Use TanStack Router for navigation and route management.
- **API Client**: The frontend uses an auto-generated API client.

## Backend-Frontend Interaction: Model and API Client Synchronization

- **OpenAPI Specification**: The backend exposes an OpenAPI specification (usually at `/openapi.json`).
- **Client Generation**: Changes to backend API routes or Pydantic/SQLModel models often require regenerating the frontend TypeScript client.
- **Script for Client Generation**: There is a script `scripts/generate-client.sh` in the root of the project that automates this process. This script:
  1.  Generates the `openapi.json` from the backend.
  2.  Uses `@hey-api/openapi-ts` (configured in `frontend/openapi-ts.config.ts`) to generate TypeScript types and service classes for the frontend based on this `openapi.json`.
  3.  Formats the generated client code using Biome.
- **Workflow for LLMs**:
  1.  Propose changes to backend models or API routes.
  2.  If changes impact the frontend client, note that the client needs to be regenerated by a human (see "Human-Only Conventions").
  3.  Propose necessary updates to frontend components to use any new or modified types/services once the client is regenerated.

## Human-Only Conventions (LLMs Should Ignore This Section)

This section outlines commands and procedures that are to be executed by human developers. **LLMs must not suggest or execute any of these commands.**

- **Backend Linting and Formatting**:
  - Run `ruff check . --fix` in the `backend` directory.
  - Run `ruff format .` in the `backend` directory.
- **Backend Static Type Checking**:
  - Run `mypy .` in the `backend` directory.
- **Database Migrations (Alembic)**:
  - To generate a new migration after model changes: `alembic revision --autogenerate -m "Descriptive message of changes"` (typically run inside the backend Docker container).
  - To apply migrations to the database: `alembic upgrade head` (typically run inside the backend Docker container).
- **Frontend Linting and Formatting**:
  - Run `npm run lint` in the `frontend` directory.
- **Frontend Client Generation**:
  - After backend API/model changes, run `bash scripts/generate-client.sh` from the project root to regenerate the frontend client.
  - Review and commit the changes in both `backend` and `frontend/src/client` directories.

By following these conventions, LLMs can contribute effectively and safely to the development of this project.
